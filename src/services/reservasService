import { Reserva } from "../models/index.js";

/**
 * Crea una nueva reserva con validación de disponibilidad
 */
export const createReserva = async (data) => {
  try {
    // Validar que no exista una reserva para la misma mesa, fecha y hora
    const existe = await Reserva.findOne({
      mesa: data.mesa,
      fecha: new Date(data.fecha),
      hora: data.hora,
    });

    if (existe) {
      throw new Error("La mesa ya está reservada en esa fecha y horario");
    }

    const reserva = new Reserva(data);
    return await reserva.save();
  } catch (error) {
    throw new Error("Error creando reserva: " + error.message);
  }
};

/**
 * Obtiene todas las reservas con filtros, búsqueda y paginación
 */
export const getAllReservas = async (filters = {}, page = 1, limit = 10) => {
  try {
    const skip = (page - 1) * limit;
    const queryObj = {};

    if (filters.nombre) {
      queryObj.nombre = { $regex: filters.nombre, $options: "i" };
    }
    if (filters.mesa) {
      queryObj.mesa = Number(filters.mesa);
    }
    if (filters.fecha) {
      queryObj.fecha = new Date(filters.fecha);
    }

    const reservas = await Reserva.find(queryObj)
      .skip(skip)
      .limit(limit)
      .sort({ fecha: 1, hora: 1 });

    const total = await Reserva.countDocuments(queryObj);

    return { reservas, total, page, limit };
  } catch (error) {
    throw new Error("Error obteniendo reservas: " + error.message);
  }
};

/**
 * Obtiene una reserva por su ID
 */
export const getReservaById = async (id) => {
  try {
    const reserva = await Reserva.findById(id);
    if (!reserva) throw new Error("Reserva no encontrada");
    return reserva;
  } catch (error) {
    throw new Error("Error obteniendo reserva: " + error.message);
  }
};

/**
 * Actualiza una reserva con validación de disponibilidad
 */
export const updateReserva = async (id, data) => {
  try {
    const existe = await Reserva.findOne({
      _id: { $ne: id },
      mesa: data.mesa,
      fecha: new Date(data.fecha),
      hora: data.hora,
    });

    if (existe) {
      throw new Error("La mesa ya está reservada en esa fecha y horario");
    }

    const reserva = await Reserva.findByIdAndUpdate(id, data, { new: true });
    if (!reserva) throw new Error("Reserva no encontrada para actualizar");

    return reserva;
  } catch (error) {
    throw new Error("Error actualizando reserva: " + error.message);
  }
};

/**
 * Elimina una reserva por su ID
 */
export const deleteReserva = async (id) => {
  try {
    const reserva = await Reserva.findByIdAndDelete(id);
    if (!reserva) throw new Error("Reserva no encontrada para eliminar");
    return reserva;
  } catch (error) {
    throw new Error("Error eliminando reserva: " + error.message);
  }
};
